using Microsoft.EntityFrameworkCore;
using NetworkFirewall.Controllers;
using NetworkFirewall.Data;
using NetworkFirewall.Hubs;
using NetworkFirewall.Models;
using NetworkFirewall.Services;
using NetworkFirewall.Services.Firewall;
using System.Text.Json.Serialization;

var builder = WebApplication.CreateBuilder(args);

// Configuration
var appSettings = builder.Configuration.GetSection("AppSettings").Get<AppSettings>() ?? new AppSettings();
builder.Services.Configure<AppSettings>(builder.Configuration.GetSection("AppSettings"));

// Configurer le port web
builder.WebHost.UseUrls($"http://0.0.0.0:{appSettings.WebPort}");

// Database
builder.Services.AddDbContext<FirewallDbContext>(options =>
    options.UseSqlite($"Data Source={appSettings.DatabasePath}"));

// Repositories
builder.Services.AddScoped<IDeviceRepository, DeviceRepository>();
builder.Services.AddScoped<IAlertRepository, AlertRepository>();
builder.Services.AddScoped<ITrafficLogRepository, TrafficLogRepository>();
builder.Services.AddScoped<ICameraRepository, CameraRepository>();
builder.Services.AddScoped<ISecurityLogRepository, SecurityLogRepository>();
builder.Services.AddScoped<IParentalControlRepository, ParentalControlRepository>();

// HTTP Client Factory for camera detection and threat intelligence
builder.Services.AddHttpClient();

// SignalR
builder.Services.AddSignalR();
builder.Services.AddSingleton<IDeviceHubNotifier, DeviceHubNotifier>();
builder.Services.AddSingleton<IAlertHubNotifier, AlertHubNotifier>();

// OUI Lookup Service (singleton avec dictionnaire en mémoire)
builder.Services.AddSingleton<IOuiLookupService, OuiLookupService>();

// First Run Detection Service (détecte la première mise en place)
builder.Services.AddSingleton<IFirstRunService, FirstRunService>();

// Firewall Engine Services (moteur de règles de blocage)
builder.Services.AddSingleton<WindowsFirewallEngine>();
builder.Services.AddSingleton<LinuxIptablesEngine>();
builder.Services.AddSingleton<FirewallEngineFactory>();
builder.Services.AddSingleton<IFirewallEngine>(sp => sp.GetRequiredService<FirewallEngineFactory>().CreateEngine());
builder.Services.AddSingleton<INetworkBlockingService, FirewallService>();

// Security Log Service (logs de sécurité avec notifications temps réel)
builder.Services.AddSingleton<ISecurityLogService, SecurityLogService>();

// Firewall Rule Restoration Service (restaure les règles au démarrage)
builder.Services.AddHostedService<FirewallRuleRestorationService>();

// Blocked Traffic Monitor Service (surveillance des tentatives de connexion bloquées)
builder.Services.AddHostedService<BlockedTrafficMonitorService>();

// Services (Singleton pour maintenir l'etat)
builder.Services.AddSingleton<INotificationService, NotificationService>();
builder.Services.AddSingleton<IPacketCaptureService, PacketCaptureService>();
builder.Services.AddSingleton<IDeviceDiscoveryService, DeviceDiscoveryService>();
builder.Services.AddSingleton<IAnomalyDetectionService, AnomalyDetectionService>();
builder.Services.AddSingleton<IBandwidthMonitorService, BandwidthMonitorService>();
builder.Services.AddSingleton<INetworkMonitoringService, NetworkMonitoringService>();
builder.Services.AddSingleton<ITrafficLoggingService, TrafficLoggingService>();
builder.Services.AddSingleton<ICameraDetectionService, CameraDetectionService>();
builder.Services.AddSingleton<IScanSessionService, ScanSessionService>();

// Scan Log Service - for real-time scan logging
builder.Services.AddSingleton<IScanLogService, ScanLogService>();

// Security Services
builder.Services.AddSingleton<IThreatIntelligenceService, ThreatIntelligenceService>();
builder.Services.AddSingleton<INetworkSecurityService, NetworkSecurityService>();

// Agent Services
builder.Services.AddSingleton<IAgentService, AgentService>();

// Pi-hole Services
builder.Services.AddSingleton<IPiholeService, PiholeService>();

// Router Services
builder.Services.AddSingleton<PortMappingService>();
builder.Services.AddHostedService<PortMappingService>(provider => provider.GetRequiredService<PortMappingService>());

// Packet Sniffer Service
builder.Services.AddSingleton<IPacketSnifferService, PacketSnifferService>();

// DHCP Service
builder.Services.AddSingleton<IDhcpService, DhcpService>();
builder.Services.AddHostedService<DhcpService>(provider => (DhcpService)provider.GetRequiredService<IDhcpService>());

// WiFi Service (gestion multi-bandes et Mesh)
builder.Services.AddSingleton<IWiFiService, WiFiService>();

// Parental Control Service (contrôle parental avec vérification périodique)
builder.Services.AddSingleton<IParentalControlService, ParentalControlService>();
builder.Services.AddHostedService<ParentalControlService>(provider => 
    (ParentalControlService)provider.GetRequiredService<IParentalControlService>());

// Network Protocol Services
builder.Services.AddSingleton<INetworkProtocolService, NetworkProtocolService>();
builder.Services.AddSingleton<INatService, NatService>();
builder.Services.AddSingleton<ISshService, SshService>();
builder.Services.AddSingleton<INtpService, NtpService>();
builder.Services.AddSingleton<ISnmpService, SnmpService>();

// ISO Compliance Services (ISO 27001 & ISO 15408)
builder.Services.AddSingleton<IIso27001Service, Iso27001Service>();
builder.Services.AddSingleton<IIso15408Service, Iso15408Service>();
builder.Services.AddSingleton<IComplianceAuditService, ComplianceAuditService>();

// Device Heartbeat Service (background service pour vérifier statut des appareils)
builder.Services.AddHostedService<DeviceHeartbeatService>();

// Network Scanner Worker (scan périodique avec notifications SignalR)
builder.Services.AddHostedService<NetworkScannerWorker>();

// Add Controllers
builder.Services.AddControllers().AddJsonOptions(options =>
{
    options.JsonSerializerOptions.Converters.Add(new JsonStringEnumConverter());
    options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
});

// Add Swagger/OpenAPI
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseDefaultFiles();

// Configuration des fichiers statiques avec encodage UTF-8
var staticFileOptions = new StaticFileOptions
{
    OnPrepareResponse = ctx =>
    {
        // Ajouter le charset UTF-8 pour les fichiers texte
        var contentType = ctx.Context.Response.ContentType;
        if (contentType != null && (
            contentType.StartsWith("text/", StringComparison.OrdinalIgnoreCase) ||
            contentType.Contains("javascript", StringComparison.OrdinalIgnoreCase) ||
            contentType.Contains("json", StringComparison.OrdinalIgnoreCase)))
        {
            if (!contentType.Contains("charset", StringComparison.OrdinalIgnoreCase))
            {
                ctx.Context.Response.ContentType = contentType + "; charset=utf-8";
            }
        }
    }
};
app.UseStaticFiles(staticFileOptions);

app.UseRouting();
app.UseAuthorization();

app.MapControllers();
app.MapNotificationEndpoints();

// Map SignalR Hubs
app.MapHub<DeviceHub>("/hubs/devices");
app.MapHub<AlertHub>("/hubs/alerts");
app.MapHub<ParentalControlHub>("/hubs/parental-control");

// Initialize Database
using (var scope = app.Services.CreateScope())
{
    var db = scope.ServiceProvider.GetRequiredService<FirewallDbContext>();
    var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();
    
    try
    {
        db.Database.EnsureCreated();
        _ = db.Alerts.FirstOrDefault();
        _ = db.Agents.FirstOrDefault();
        // Vérifier aussi les nouveaux champs du modèle Device et SecurityLogs
        _ = db.Devices.Select(d => d.IsBlocked).FirstOrDefault();
        _ = db.SecurityLogs.FirstOrDefault();
        // Vérifier les tables de contrôle parental
        _ = db.ChildProfiles.FirstOrDefault();
    }
    catch (Exception ex)
    {
        logger.LogWarning(ex, "Database schema mismatch detected. Recreating database...");
        try
        {
            db.Database.EnsureDeleted();
            db.Database.EnsureCreated();
            logger.LogInformation("Database recreated successfully.");
        }
        catch (Exception retryEx)
        {
            logger.LogError(retryEx, "Failed to recreate database.");
        }
    }
}

app.Run();



























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































